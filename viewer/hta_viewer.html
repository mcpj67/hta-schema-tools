<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTA Schema Viewer & Computation Engine</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;600;700&family=IBM+Plex+Mono:wght@400;500&family=Source+Serif+4:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a3a52;
            --secondary: #2d5f7f;
            --accent: #c17767;
            --background: #fafaf8;
            --surface: #ffffff;
            --border: #e0ddd8;
            --text: #1a1a1a;
            --text-muted: #666666;
            --success: #2d7d4f;
            --warning: #c17767;
            --error: #c14343;
            --shadow: rgba(26, 58, 82, 0.08);
        }

        body {
            font-family: 'Source Serif 4', serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
        }

        .app {
            min-height: 100vh;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 2.5rem 2rem;
            border-bottom: 4px solid var(--accent);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .upload-zone {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
        }

        .upload-zone:hover {
            border-color: var(--secondary);
            background: #f8f8f6;
        }

        .upload-zone.dragover {
            border-color: var(--accent);
            background: #fff9f7;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }

        .upload-text {
            font-size: 1.2rem;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .upload-subtext {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .model-info {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .model-info h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .info-item {
            border-left: 3px solid var(--accent);
            padding-left: 1rem;
        }

        .info-label {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 1.1rem;
            color: var(--text);
            font-weight: 600;
        }

        .results-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .results-section h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border);
            padding-bottom: 0.75rem;
        }

        .strategy-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .strategy-card {
            background: #f8f8f6;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .strategy-card:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .strategy-name {
            font-family: 'Crimson Pro', serif;
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .metric-value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
            color: var(--text);
            font-size: 1rem;
        }

        .icer-result {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
            margin-top: 2rem;
        }

        .icer-label {
            font-size: 0.9rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 0.5rem;
        }

        .icer-value {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .icer-description {
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .tree-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .tree-section h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .tree-container {
            overflow-x: auto;
            padding: 1rem;
            background: #fafaf8;
            border-radius: 4px;
        }

        .node {
            background: white;
            border: 2px solid var(--border);
            border-radius: 6px;
            padding: 1rem 1.5rem;
            margin: 0.5rem;
            display: inline-block;
            min-width: 150px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .node:hover {
            border-color: var(--secondary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .node-decision {
            border-color: var(--primary);
            background: linear-gradient(135deg, #ffffff 0%, #f0f4f7 100%);
        }

        .node-chance {
            border-color: var(--secondary);
        }

        .node-terminal {
            border-color: var(--accent);
            background: linear-gradient(135deg, #ffffff 0%, #fff9f7 100%);
        }

        .node-label {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        .node-type {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.05em;
        }

        .parameters-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .parameters-section h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            font-weight: 700;
        }

        .param-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
        }

        .param-table th {
            background: var(--primary);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .param-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
        }

        .param-table tr:hover {
            background: #f8f8f6;
        }

        .param-type {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .param-value {
            font-family: 'IBM Plex Mono', monospace;
            font-weight: 500;
            color: var(--text);
        }

        .error-message {
            background: #fff5f5;
            border: 2px solid var(--error);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            color: var(--error);
        }

        .error-message h3 {
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Source Serif 4', serif;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .button:hover {
            background: var(--secondary);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        code {
            font-family: 'IBM Plex Mono', monospace;
            background: #f0f0f0;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect } = React;

        // Computation Engine
        class HTAComputationEngine {
            constructor(model) {
                this.model = model;
                this.parameters = model.parameters;
                this.settings = model.analysis_settings.base_case;
            }

            getParameterValue(paramRef) {
                const param = this.parameters[paramRef];
                return param ? param.base_value : 0;
            }

            calculateDiscountFactor(years, rate) {
                return Math.pow(1 + rate, -years);
            }

            evaluateTerminalNode(node) {
                const outcomes = node.outcomes;
                let totalCost = 0;
                let totalQALYs = 0;

                const timeHorizon = this.getParameterValue('time_horizon') || this.settings.time_horizon;
                const discountRateCosts = this.settings.discount_rate_costs;
                const discountRateOutcomes = this.settings.discount_rate_outcomes;

                // Calculate costs
                for (const cost of outcomes.costs || []) {
                    const value = this.getParameterValue(cost.value.parameter_ref);
                    
                    if (cost.timing === 'immediate') {
                        totalCost += value;
                    } else if (cost.timing === 'annual') {
                        const duration = this.getParameterValue(cost.duration_years.parameter_ref) || timeHorizon;
                        for (let year = 1; year <= duration; year++) {
                            totalCost += value * this.calculateDiscountFactor(year, discountRateCosts);
                        }
                    }
                }

                // Calculate QALYs
                for (const utility of outcomes.utilities || []) {
                    const value = this.getParameterValue(utility.value.parameter_ref);
                    
                    if (utility.timing === 'annual') {
                        const duration = this.getParameterValue(utility.duration_years.parameter_ref) || timeHorizon;
                        for (let year = 1; year <= duration; year++) {
                            totalQALYs += value * this.calculateDiscountFactor(year, discountRateOutcomes);
                        }
                    }
                }

                return { cost: totalCost, qalys: totalQALYs };
            }

            evaluateChanceNode(node) {
                let expectedCost = 0;
                let expectedQALYs = 0;

                for (const branch of node.branches) {
                    const probability = this.getParameterValue(branch.probability.parameter_ref);
                    const targetNode = this.model.model_structure.nodes[branch.target_node];
                    const result = this.evaluateNode(targetNode);
                    
                    expectedCost += probability * result.cost;
                    expectedQALYs += probability * result.qalys;
                }

                return { cost: expectedCost, qalys: expectedQALYs };
            }

            evaluateDecisionBranch(branch) {
                const initialCost = branch.initial_cost 
                    ? this.getParameterValue(branch.initial_cost.parameter_ref) 
                    : 0;
                
                const targetNode = this.model.model_structure.nodes[branch.target_node];
                const result = this.evaluateNode(targetNode);
                
                return {
                    cost: initialCost + result.cost,
                    qalys: result.qalys
                };
            }

            evaluateNode(node) {
                switch (node.node_type) {
                    case 'terminal':
                        return this.evaluateTerminalNode(node);
                    case 'chance':
                        return this.evaluateChanceNode(node);
                    case 'decision':
                        throw new Error('Decision nodes should be evaluated per branch');
                    default:
                        return { cost: 0, qalys: 0 };
                }
            }

            runAnalysis() {
                const rootNode = this.model.model_structure.nodes[this.model.model_structure.root_node];
                const strategies = {};

                for (const branch of rootNode.branches) {
                    const result = this.evaluateDecisionBranch(branch);
                    strategies[branch.label] = {
                        cost: result.cost,
                        qalys: result.qalys,
                        branch_id: branch.branch_id
                    };
                }

                return this.calculateICER(strategies);
            }

            calculateICER(strategies) {
                const strategyArray = Object.entries(strategies).map(([name, data]) => ({
                    name,
                    ...data
                }));

                // Sort by cost
                strategyArray.sort((a, b) => a.cost - b.cost);

                // Assume first strategy is baseline
                if (strategyArray.length >= 2) {
                    const baseline = strategyArray[0];
                    const intervention = strategyArray[1];
                    
                    const incrementalCost = intervention.cost - baseline.cost;
                    const incrementalQALYs = intervention.qalys - baseline.qalys;
                    const icer = incrementalQALYs !== 0 ? incrementalCost / incrementalQALYs : null;

                    return {
                        strategies: strategyArray,
                        baseline: baseline.name,
                        intervention: intervention.name,
                        incrementalCost,
                        incrementalQALYs,
                        icer
                    };
                }

                return { strategies: strategyArray };
            }
        }

        function HTAViewer() {
            const [model, setModel] = useState(null);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [dragOver, setDragOver] = useState(false);

            const processModel = useCallback((modelData) => {
                try {
                    setError(null);
                    setModel(modelData);
                    
                    const engine = new HTAComputationEngine(modelData);
                    const analysisResults = engine.runAnalysis();
                    setResults(analysisResults);
                } catch (err) {
                    setError(err.message);
                    console.error('Error processing model:', err);
                }
            }, []);

            const handleFile = useCallback((file) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const modelData = JSON.parse(e.target.result);
                        processModel(modelData);
                    } catch (err) {
                        setError('Invalid JSON file');
                    }
                };
                reader.readAsText(file);
            }, [processModel]);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                setDragOver(false);
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            }, [handleFile]);

            const handleFileInput = useCallback((e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            }, [handleFile]);

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-GB', {
                    style: 'currency',
                    currency: model?.model_metadata?.currency || 'GBP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            };

            const formatNumber = (value, decimals = 3) => {
                return value.toFixed(decimals);
            };

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-content">
                            <h1>HTA Schema Viewer & Computation Engine</h1>
                            <p>Upload a decision tree model to visualize structure and compute cost-effectiveness results</p>
                        </div>
                    </header>

                    <div className="container">
                        {!model && (
                            <div 
                                className={`upload-zone ${dragOver ? 'dragover' : ''}`}
                                onDrop={handleDrop}
                                onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                                onDragLeave={() => setDragOver(false)}
                                onClick={() => document.getElementById('file-input').click()}
                            >
                                <div className="upload-icon">ðŸ“Š</div>
                                <div className="upload-text">Drop HTA Schema JSON file here</div>
                                <div className="upload-subtext">or click to browse</div>
                                <input 
                                    id="file-input"
                                    type="file" 
                                    accept=".json"
                                    onChange={handleFileInput}
                                    style={{ display: 'none' }}
                                />
                            </div>
                        )}

                        {error && (
                            <div className="error-message">
                                <h3>Error</h3>
                                <p>{error}</p>
                            </div>
                        )}

                        {model && (
                            <>
                                <div className="model-info">
                                    <h2>{model.model_metadata.model_name}</h2>
                                    <p>{model.model_metadata.description}</p>
                                    
                                    <div className="info-grid">
                                        <div className="info-item">
                                            <div className="info-label">Model Type</div>
                                            <div className="info-value">{model.model_metadata.model_type}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-label">Clinical Area</div>
                                            <div className="info-value">{model.model_metadata.clinical_area}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-label">Setting</div>
                                            <div className="info-value">{model.model_metadata.setting}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-label">Currency</div>
                                            <div className="info-value">{model.model_metadata.currency} ({model.model_metadata.currency_year})</div>
                                        </div>
                                    </div>
                                    
                                    <button 
                                        className="button" 
                                        onClick={() => { setModel(null); setResults(null); setError(null); }}
                                        style={{ marginTop: '1.5rem' }}
                                    >
                                        Load Different Model
                                    </button>
                                </div>

                                {results && (
                                    <div className="results-section">
                                        <h2>Cost-Effectiveness Results</h2>
                                        
                                        <div className="strategy-results">
                                            {results.strategies.map(strategy => (
                                                <div key={strategy.name} className="strategy-card">
                                                    <div className="strategy-name">{strategy.name}</div>
                                                    <div className="metric">
                                                        <span className="metric-label">Total Cost</span>
                                                        <span className="metric-value">{formatCurrency(strategy.cost)}</span>
                                                    </div>
                                                    <div className="metric">
                                                        <span className="metric-label">Total QALYs</span>
                                                        <span className="metric-value">{formatNumber(strategy.qalys)}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {results.icer !== null && results.icer !== undefined && (
                                            <div className="icer-result">
                                                <div className="icer-label">Incremental Cost-Effectiveness Ratio</div>
                                                <div className="icer-value">{formatCurrency(results.icer)} per QALY</div>
                                                <div className="icer-description">
                                                    {results.intervention} vs {results.baseline}: 
                                                    Incremental cost {formatCurrency(results.incrementalCost)}, 
                                                    Incremental QALYs {formatNumber(results.incrementalQALYs, 3)}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                <div className="tree-section">
                                    <h2>Decision Tree Structure</h2>
                                    <div className="tree-container">
                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>
                                            {Object.entries(model.model_structure.nodes).slice(0, 8).map(([id, node]) => (
                                                <div key={id} className={`node node-${node.node_type}`}>
                                                    <div className="node-label">{node.label}</div>
                                                    <div className="node-type">{node.node_type}</div>
                                                </div>
                                            ))}
                                        </div>
                                        <p style={{ marginTop: '1rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>
                                            Showing {Math.min(8, Object.keys(model.model_structure.nodes).length)} of {Object.keys(model.model_structure.nodes).length} nodes
                                        </p>
                                    </div>
                                </div>

                                <div className="parameters-section">
                                    <h2>Model Parameters ({Object.keys(model.parameters).length} total)</h2>
                                    <table className="param-table">
                                        <thead>
                                            <tr>
                                                <th>Parameter Name</th>
                                                <th>Type</th>
                                                <th>Base Value</th>
                                                <th>Source</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.entries(model.parameters).slice(0, 15).map(([id, param]) => (
                                                <tr key={id}>
                                                    <td>{param.name}</td>
                                                    <td className="param-type">{param.type}</td>
                                                    <td className="param-value">
                                                        {param.type === 'cost' ? formatCurrency(param.base_value) : formatNumber(param.base_value, 4)}
                                                    </td>
                                                    <td style={{ fontSize: '0.85rem', color: 'var(--text-muted)' }}>
                                                        {param.source?.substring(0, 50)}{param.source?.length > 50 ? '...' : ''}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {Object.keys(model.parameters).length > 15 && (
                                        <p style={{ marginTop: '1rem', color: 'var(--text-muted)', fontSize: '0.9rem' }}>
                                            Showing 15 of {Object.keys(model.parameters).length} parameters
                                        </p>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<HTAViewer />, document.getElementById('root'));
    </script>
</body>
</html>
